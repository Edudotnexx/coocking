name: ğŸ”„ Auto Update Configs

on:
  schedule:
    # Ø§Ø¬Ø±Ø§ Ù‡Ø± 6 Ø³Ø§Ø¹Øª
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
    inputs:
      source:
        description: 'Ù…Ù†Ø¨Ø¹ Ú©Ø§Ù†ÙÛŒÚ¯ (all, vmess_iran, mixed_iran, etc.)'
        required: false
        default: 'all'
      test_configs:
        description: 'ØªØ³Øª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ Ø¨Ø¹Ø¯ Ø§Ø² Ø¯Ø±ÛŒØ§ÙØª'
        type: boolean
        required: false
        default: true

jobs:
  update-configs:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” Fetch Configs
      id: fetch
      run: |
        echo "ğŸš€ Ø´Ø±ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§..."
        
        # Ø§Ø¬Ø±Ø§ÛŒ script Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†ÙÛŒÚ¯
        python scripts/fetch_configs.py --source="${{ github.event.inputs.source || 'all' }}" --output="data/configs.json"
        
        # Ø°Ø®ÛŒØ±Ù‡ Ø¢Ù…Ø§Ø±
        CONFIGS_COUNT=$(python -c "import json; data=json.load(open('data/configs.json')); print(len(data.get('configs', [])))")
        echo "configs_count=$CONFIGS_COUNT" >> $GITHUB_OUTPUT
        echo "âœ… ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ: $CONFIGS_COUNT"
        
    - name: ğŸ§ª Test Configs (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
      if: ${{ github.event.inputs.test_configs == 'true' || github.event_name == 'schedule' }}
      run: |
        echo "ğŸ”¬ Ø´Ø±ÙˆØ¹ ØªØ³Øª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§..."
        
        # ØªØ³Øª Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù‡ 20 Ú©Ø§Ù†ÙÛŒÚ¯ Ø§ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª
        python scripts/test_configs.py --input="data/configs.json" --output="data/test_results.json" --limit=20
        
        # Ø¢Ù…Ø§Ø± ØªØ³Øª
        python -c "
        import json
        data = json.load(open('data/test_results.json'))
        stats = data.get('stats', {})
        print(f'âœ… ÙØ¹Ø§Ù„: {stats.get(\"active\", 0)}')
        print(f'âš ï¸  Ú©Ù†Ø¯: {stats.get(\"slow\", 0)}')
        print(f'âŒ ØºÛŒØ±ÙØ¹Ø§Ù„: {stats.get(\"dead\", 0)}')
        "
        
    - name: ğŸ“Š Generate Report
      run: |
        echo "ğŸ“‹ ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´..."
        python scripts/generate_report.py --configs="data/configs.json" --tests="data/test_results.json" --output="data/report.md"
        
    - name: ğŸ·ï¸ Create Release
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ØªÙˆÙ„ÛŒØ¯ tag Ø¬Ø¯ÛŒØ¯
        TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
        TAG="configs-$TIMESTAMP"
        
        # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ release
        if gh release create "$TAG" \
          data/configs.json \
          data/test_results.json \
          data/report.md \
          --title "ğŸ”„ Auto Update - $TIMESTAMP" \
          --notes "
        ## ğŸ“Š Ø¢Ù…Ø§Ø± Ø§ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
        
        - ğŸ” **ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§:** ${{ steps.fetch.outputs.configs_count }}
        - ğŸ“… **Ø²Ù…Ø§Ù†:** $(date +'%Y-%m-%d %H:%M:%S UTC')
        - ğŸ¤– **Ø±ÙˆØ´:** GitHub Actions (Ø®ÙˆØ¯Ú©Ø§Ø±)
        
        ## ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯
        
        - [configs.json](./configs.json) - ØªÙ…Ø§Ù… Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§
        - [test_results.json](./test_results.json) - Ù†ØªØ§ÛŒØ¬ ØªØ³Øª
        - [report.md](./report.md) - Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„
        
        ## ğŸš€ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø³Ø±ÛŒØ¹
        
        \`\`\`bash
        curl -O https://github.com/${{ github.repository }}/releases/download/$TAG/configs.json
        \`\`\`
        " \
          --latest 2>/dev/null; then
          echo "âœ… Release created successfully"
        else
          echo "âš ï¸ Release creation failed, but continuing with artifacts"
        fi
          
    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: config-update-${{ github.run_number }}
        path: |
          data/configs.json
          data/test_results.json
          data/report.md
        retention-days: 30
        
    - name: ğŸ“± Send Notification (Telegram)
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          MESSAGE="âœ… *Ú©Ø§Ù†ÙÛŒÚ¯ ÛŒØ§Ø¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ*%0A%0AğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙÙ‚%0AğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§: ${{ steps.fetch.outputs.configs_count }}%0AğŸ“… Ø²Ù…Ø§Ù†: $(date +'%Y-%m-%d %H:%M:%S')"
        else
          MESSAGE="âŒ *Ú©Ø§Ù†ÙÛŒÚ¯ ÛŒØ§Ø¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ*%0A%0AğŸš« Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ%0AğŸ“… Ø²Ù…Ø§Ù†: $(date +'%Y-%m-%d %H:%M:%S')"
        fi
        
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
          curl -s "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage?chat_id=$TELEGRAM_CHAT_ID&text=$MESSAGE&parse_mode=Markdown"
        fi

  deploy-github-pages:
    needs: update-configs
    runs-on: ubuntu-latest
    if: success()
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: config-update-${{ github.run_number }}
        path: ./public/data/
        
    - name: ğŸ—ï¸ Build Static Site
      run: |
        # Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ web
        mkdir -p public
        cp index.html public/ 2>/dev/null || echo "âš ï¸ index.html not found, creating minimal version"
        cp app.js public/ 2>/dev/null || echo "âš ï¸ app.js not found, creating minimal version"
        cp -r assets public/ 2>/dev/null || echo "âš ï¸ assets directory not found, skipping"
        
        # Ø§ÛŒØ¬Ø§Ø¯ index.html Ø³Ø§Ø¯Ù‡ Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯
        if [ ! -f "public/index.html" ]; then
          cat > public/index.html << 'EOF'
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú©Ø§Ù†ÙÛŒÚ¯ ÛŒØ§Ø¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .stats { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ Ú©Ø§Ù†ÙÛŒÚ¯ ÛŒØ§Ø¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</h1>
        <p>Ø³ÛŒØ³ØªÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ùˆ ØªØ³Øª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ V2Ray</p>
        <div class="stats">
            <h3>ğŸ“Š Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§:</h3>
            <ul>
                <li><a href="./data/configs.json">configs.json</a> - ØªÙ…Ø§Ù… Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§</li>
                <li><a href="./data/test_results.json">test_results.json</a> - Ù†ØªØ§ÛŒØ¬ ØªØ³Øª</li>
                <li><a href="./data/report.md">report.md</a> - Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„</li>
                <li><a href="./api/">API</a> - Ø±Ø§Ø¨Ø· Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ</li>
            </ul>
        </div>
    </div>
</body>
</html>
EOF
        fi
        
        # ØªÙˆÙ„ÛŒØ¯ API mock Ø¨Ø±Ø§ÛŒ GitHub Pages
        python scripts/generate_static_api.py --configs="public/data/configs.json" --output="public/api/" || echo "âš ï¸ API generation failed"
        
    - name: ğŸ“„ Setup Pages
      uses: actions/configure-pages@v3
      
    - name: ğŸš€ Upload to Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: './public'
        
    - name: ğŸŒ Deploy to Pages
      id: deployment
      uses: actions/deploy-pages@v2
